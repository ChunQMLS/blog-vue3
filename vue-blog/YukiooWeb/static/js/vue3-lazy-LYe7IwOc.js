/*!
 * vue3-lazy v1.0.0-alpha.1
 * (c) 2020-2020 ustbhuangyi
 * Released under the MIT License.
 */
var e,t;(t=e||(e={}))[t.loading=0]="loading",t[t.loaded=1]="loaded",t[t.error=2]="error";var r="undefined"!=typeof window,n=function(){if(r&&"IntersectionObserver"in window&&"IntersectionObserverEntry"in window&&"intersectionRatio"in IntersectionObserverEntry.prototype)return"isIntersecting"in IntersectionObserverEntry.prototype||Object.defineProperty(IntersectionObserverEntry.prototype,"isIntersecting",{get:function(){return this.intersectionRatio>0}}),!0;return!1}();var i=function(e,t){return getComputedStyle(e).getPropertyValue(t)},o=function(e){return i(e,"overflow")+i(e,"overflow-y")+i(e,"overflow-x")};var a=function(){function t(t){this.el=t.el,this.parent=t.parent,this.src=t.src,this.error=t.error,this.loading=t.loading,this.cache=t.cache,this.state=e.loading,this.render(this.loading)}return t.prototype.load=function(t){if(!(this.state>e.loading))return this.cache.has(this.src)?(this.state=e.loaded,void this.render(this.src)):void this.renderSrc(t)},t.prototype.isInView=function(){var e=this.el.getBoundingClientRect();return e.top<window.innerHeight&&e.left<window.innerWidth},t.prototype.update=function(t){t!==this.src&&(this.src=t,this.state=e.loading)},t.prototype.renderSrc=function(t){var r,n=this;(r=this.src,new Promise((function(e,t){var n=new Image;function i(){n.onload=n.onerror=null}n.onload=function(){e(),i()},n.onerror=function(e){t(e),i()},n.src=r}))).then((function(){n.state=e.loaded,n.render(n.src),n.cache.add(n.src),t&&t()})).catch((function(r){n.state=e.error,n.render(n.error),n.src,r.message,t&&t()}))},t.prototype.render=function(e){this.el.setAttribute("src",e)},t}();var s="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",u=["scroll","wheel","mousewheel","resize","animationend","transitionend","touchmove","transitioncancel"],d=function(){function t(e){var t,r,n,i;this.error=e.error||s,this.loading=e.loading||s,this.cache=new Set,this.managerQueue=[],this.throttleLazyHandler=(t=this.lazyHandler.bind(this),r=300,n=0,i=0,function(){if(!n){var e=Date.now()-i,o=this,a=arguments,s=function(){i=Date.now(),n=0,t.apply(o,a)};e>=r?s():n=window.setTimeout(s,r)}}),this.init()}return t.prototype.add=function(e,t){var r=t.value,i=function(e){for(var t=e;t&&t!==document.body&&t!==document.documentElement&&t.parentNode;){if(/(scroll|auto)/.test(o(t)))return t;t=t.parentNode}return window}(e),s=new a({el:e,parent:i,src:r,error:this.error,loading:this.loading,cache:this.cache});this.managerQueue.push(s),n?this.observer.observe(e):(this.addListenerTarget(i),this.addListenerTarget(window),this.throttleLazyHandler())},t.prototype.update=function(e,t){var r=t.value,n=this.managerQueue.find((function(t){return t.el===e}));n&&n.update(r)},t.prototype.remove=function(e){var t=this.managerQueue.find((function(t){return t.el===e}));t&&this.removeManager(t)},t.prototype.init=function(){n?this.initIntersectionObserver():this.targetQueue=[]},t.prototype.initIntersectionObserver=function(){var t=this;this.observer=new IntersectionObserver((function(r){r.forEach((function(r){if(r.isIntersecting){var n=t.managerQueue.find((function(e){return e.el===r.target}));if(n){if(n.state===e.loaded)return void t.removeManager(n);n.load()}}}))}),{rootMargin:"0px",threshold:0})},t.prototype.addListenerTarget=function(e){var t=this.targetQueue.find((function(t){return t.el===e}));t?t.ref++:(t={el:e,ref:1},this.targetQueue.push(t),this.addListener(e))},t.prototype.removeListenerTarget=function(e){var t=this;this.targetQueue.some((function(r,n){return e===r.el&&(r.ref--,r.ref||(t.removeListener(e),t.targetQueue.splice(n,1)),!0)}))},t.prototype.addListener=function(e){var t=this;u.forEach((function(r){e.addEventListener(r,t.throttleLazyHandler,{passive:!0,capture:!1})}))},t.prototype.removeListener=function(e){var t=this;u.forEach((function(r){e.removeEventListener(r,t.throttleLazyHandler)}))},t.prototype.lazyHandler=function(t){for(var r=this.managerQueue.length-1;r>=0;r--){var n=this.managerQueue[r];if(n.isInView()){if(n.state===e.loaded)return void this.removeManager(n);n.load()}}},t.prototype.removeManager=function(e){var t=this.managerQueue.indexOf(e);t>-1&&this.managerQueue.splice(t,1),this.observer?this.observer.unobserve(e.el):(this.removeListenerTarget(e.parent),this.removeListenerTarget(window))},t}(),c={install:function(e,t){var r=new d(t);e.directive("lazy",{mounted:r.add.bind(r),updated:r.update.bind(r),unmounted:r.update.bind(r)})}};export{c as l};
